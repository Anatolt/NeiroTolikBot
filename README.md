# NeiroTolikBot

Telegram бот с поддержкой генерации текста через OpenRouter и изображений через PiAPI.ai.

### Основные функции
- [x] Генерация изображений
- [x] Обработка кастомных промптов
- [x] Память контекста для последних сообщений
- [x] Получение списка моделей
- [ ] Загрузка списка моделей в бота, чтобы к ним можно было обращаться
- [x] Работа в групповых чатах
- [ ] Суммаризация контекста для групповых чатов
- [ ] Оценка объема контекста
- [ ] Суммаризация контекста и сохранение в БД
- [ ] Конфигурация окружения для тестового бота
- [ ] Обработка английских ключевых слов
- [ ] Модель для роутинга запросов
- [ ] Выбор модели по умолчанию (например, отвечай всегда антропиком или всегда сначала генери картинку)
- [ ] Возможность убрать системный промт (забудь что ты Нейротолик)
- [ ] Возможность отправить модель в loop для самодиалога (или диалога с другой моделью) до получения качественного ответа, определения невозможности ответа или пока не упрётся в лимит
- [ ] Бот пишет админу об обновлении кода
- [ ] Бот пишет о ходе селф-тестов
- [ ] Отображение "бот пишет"
- [ ] Задержка перед ответом в 5-15 сек. Реальные люди не отвечают мгновенно, тем более простынями текста
- [ ] Если текст длинный - разбивать его на несколько сообщений
- [ ] Ответ реакциями на сообщения в групповом чате
- [ ] Подключить несколько апи сервисов для ллм
- [ ] Команда "консилиум" для одновременного запроса нескольких моделей (авто 3 модели или перечень из сообщения)
- [ ] Добавить grok в шорткаты и вывести список шорткатов командой
- [ ] Команда перезагрузки бота (только для админа)
- [ ] Авторизация/режим админа в боте
- [ ] Оповещения о перезапуске, добавлении в новый чат, новых пользователях и статистика по ним

### Улучшения интерфейса
- [ ] Индикация статуса генерации ответа
- [ ] Проверка размера контекста
- [ ] Команда "новый диалог" (сброс текущего диалога с сохранением общения с пользователем в саммари)
- [ ] Команды очистки памяти:
  - [ ] "очисти память"
  - [ ] "полностью очисти память"
  - [ ] "забудь всё"

### Технические улучшения
- [ ] Вынести генерацию изображений в отдельный модуль
- [ ] Разделить остальные функции по модулям
- [ ] Добавить дополнительные сети для генерации изображений
- [ ] Добавить возможность просмотра веб-страниц
- [ ] Уведомления о статусе бота
- [ ] Параллельный запуск нескольких моделей -> консилиум
- [ ] Система монетизации
- [ ] Горячая перезагрузка модулей без перезапуска бота
- [ ] Работа с голосовухами
   - [ ] 1 Возможность кинуть голосовое и оценку длительности его обработки
   - [ ] 2 Возможность кинуть голосовое и получить его расшифровку
   - [ ] 3 Возможность кинуть голосовое и получить его саммари
   - [ ] 4 Возможность написать боту голосовое и он ответит текстом

### Тестирование
- [ ] Тесты API сервисов (OpenRouter и PiAPI.ai)
- [ ] Система автотестов запросов в API (без генерации, с проверкой доступности и корректности ответов API)

## Структура проекта

```
NeiroTolikBot/
├── handlers/              # Обработчики команд и сообщений
│   ├── commands.py       # Обработчики команд (например, /start)
│   └── messages.py       # Обработчики сообщений и логика маршрутизации
├── services/             # Сервисы генерации и другие сервисы
│   ├── generation.py     # Функции для генерации текста и изображений
│   └── memory.py        # Управление памятью и контекстом диалогов
├── utils/                # Вспомогательные функции
│   └── helpers.py        # Утилиты (экранирование, инициализация)
├── config.py            # Конфигурация бота
├── tbot.py              # Основной файл бота
├── .env                 # Переменные окружения
└── README.md           # Документация
```

## Установка и запуск

> ⚠️ Рекомендуется работать в виртуальном окружении, чтобы не трогать системный Python.

1. Клонируйте репозиторий
2. Создайте и активируйте виртуальное окружение:
   ```bash
   cd NeiroTolikBot
   python3 -m venv venv
   source venv/bin/activate
   ```
3. Установите зависимости:
   ```bash
   pip install -r requirements.txt
   ```
3. Создайте файл `.env` со следующими переменными:
   ```
   TELEGRAM_BOT_TOKEN=ваш_токен_бота
   OPENROUTER_API_KEY=ваш_ключ_openrouter
   PIAPI_KEY=ваш_ключ_piapi (опционально)
   CUSTOM_SYSTEM_PROMPT=ваш_промпт (опционально)
   ```
4. Запустите бота:
   ```bash
   python tbot.py
   ```

### Запуск как systemd-сервис

В репозитории уже есть файл `neirotolikbot.service`.

```bash
sudo cp neirotolikbot.service /etc/systemd/system/
sudo systemctl daemon-reload
sudo systemctl enable neirotolikbot.service
sudo systemctl start neirotolikbot.service
```

Логи: `sudo journalctl -u neirotolikbot.service -f`

## Запуск в Docker с ограничением памяти

Для работы в окружениях с ограниченными ресурсами можно использовать контейнер с лимитом памяти 150 МБ.

1. Постройте образ и запустите через Docker Compose (файл `docker-compose.yml` уже настроен на лимит памяти):
   ```bash
   docker compose up --build -d
   ```

2. Или запустите вручную, задав ограничение по памяти:
   ```bash
   docker build -t neirotolikbot .
   docker run --rm -d --env-file .env --memory=150m --name neirotolikbot neirotolikbot
   ```

Через переменные окружения можно управлять дополнительными настройками для экономии ресурсов:
- `UPDATE_QUEUE_MAXSIZE` — максимальный размер очереди обновлений (по умолчанию 50)
- `MAX_CONCURRENT_UPDATES` — максимальное число одновременно обрабатываемых обновлений (по умолчанию 2)

## Автоматическое обновление из GitHub

В проекте есть простой механизм CI/CD, который подтягивает изменения из GitHub и перезапускает бота после каждого push в `main/master`.

### Компоненты

- `webhook_server.py` — небольшой Flask-сервер, принимающий webhook от GitHub
- `deploy.sh` — скрипт, который:
  - делает `git pull`
  - определяет, запущен бот через systemd или Docker
  - перезапускает нужный сервис/контейнер
- `webhook.service` — пример systemd-сервиса для webhook-сервера

### Настройка

1. **Переменные окружения** (добавьте в `.env`):
   ```
   GITHUB_WEBHOOK_SECRET=случайная_строка_из_32_символов
   WEBHOOK_PORT=5000
   WEBHOOK_HOST=0.0.0.0
   ```
   Сгенерировать секрет: `python3 -c "import secrets; print(secrets.token_urlsafe(32))"`

2. **Убедитесь, что зависимости установлены** (см. раздел «Установка и запуск»).

3. **Запустите webhook-сервер как сервис**:
   ```bash
   sudo cp webhook.service /etc/systemd/system/
   sudo systemctl daemon-reload
   sudo systemctl enable webhook.service
   sudo systemctl start webhook.service
   sudo journalctl -u webhook.service -f  # проверки
   ```

4. **Настройте GitHub Webhook**:
   - GitHub → Settings → Webhooks → Add webhook
   - Payload URL: `http(s)://ВАШ_СЕРВЕР:5000/webhook`
   - Content type: `application/json`
   - Secret: то же значение, что `GITHUB_WEBHOOK_SECRET`
   - Events: Just the push event

5. **Пробросьте порт**:
   - откройте 5000/TCP в файрволе (`sudo ufw allow 5000/tcp`)
   - либо повесьте nginx/Cloudflare/ngrok поверх сервиса

6. **Тест**: в настройках webhook нажмите «Redeliver» или сделайте тестовый push.

### Как это работает

1. GitHub присылает запрос на `/webhook`
2. `webhook_server.py` проверяет подпись и запускает `deploy.sh`
3. Скрипт определяет окружение:
   - если поднят Docker (`docker-compose.yml`), пересобирает и перезапускает контейнер
   - иначе перезапускает `neirotolikbot.service`
   - если ничего из перечисленного не найдено — только делает `git pull`
4. Бот обновляется до последнего коммита

## Возможности

- Генерация текста через различные модели (ChatGPT, Claude, DeepSeek)
- Генерация изображений через PiAPI.ai
- Работа в группах (требуется упоминание бота или ответ на сообщение бота)
- Гибкая маршрутизация запросов
- Управление памятью и контекстом диалогов

## Использование

### Личные сообщения
- Просто напишите свой вопрос
- Укажите модель в начале или конце запроса
- Для генерации изображений используйте ключевые слова "нарисуй" или "сгенерируй картинку"

### Групповые чаты

**⚠️ Важно: перед использованием бота в группах необходимо отключить Privacy Mode!**

#### Настройка бота для работы в группах

1. **Отключите Privacy Mode через @BotFather:**
   - Откройте [@BotFather](https://t.me/BotFather) в Telegram
   - Отправьте команду `/mybots`
   - Выберите вашего бота (NeiroTolikBot)
   - Нажмите "Bot Settings"
   - Выберите "Group Privacy"
   - Нажмите "Turn off" (выключить)

   Это необходимо, чтобы бот мог получать все сообщения из групп, а не только команды и ответы на свои сообщения.

2. **Добавьте бота в группу:**
   - Добавьте бота в группу как обычного участника
   - Бот должен иметь возможность читать сообщения

3. **Использование в группе:**
   - Упомяните бота в сообщении: `@NeiroTolikBot привет`
   - Или ответьте на сообщение бота (бот автоматически обработает ответ без упоминания)
   - Используйте те же команды, что и в личных сообщениях
   - Бот будет реагировать на сообщения с упоминанием или на ответы к его сообщениям

### Управление памятью
- `/new` - Начать новый диалог (сохраняет историю для будущего использования)
- `/clear` - Полностью очистить память бота
- `/help` - Показать справку по командам

## Консольное тестирование без Telegram

Для быстрого прогона смоук-тестов и проверки ключа OpenRouter можно использовать скрипт `utils/console_tester.py`. Он также умеет офлайн проверять команды /help и /models.

### Запуск смоук-тестов

```bash
python utils/console_tester.py --run-tests --api-key "<OPENROUTER_API_KEY>"
```

Тесты проверяют:
- доступность основной модели;
- базовую генерацию ответа;
- переключение на альтернативную модель;
- работу памяти и наличие истории в SQLite.

Если основная модель недоступна, отчёт помечает остальные шаги как пропущенные, но тестирование не прерывается.

### Офлайн-проверка команд

Можно прогнать ответы на /help и /models без доступа к OpenRouter:

```bash
python utils/console_tester.py --run-command-tests
```

### Интерактивный режим

```bash
python utils/console_tester.py --interactive --api-key "<OPENROUTER_API_KEY>"
```

Дополнительные параметры:
- `--model` — основная модель (по умолчанию `anthropic/claude-3-haiku`);
- `--alternate-model` — модель для проверки переключения;
- `--prompt` — отправить один промпт и вывести ответ;
- `--run-command-tests` — запустить офлайн-тесты команд /help и /models.
